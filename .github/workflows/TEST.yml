name: Build LEDE Test

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  TZ: Asia/Shanghai
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  CCACHE_DIR: /home/runner/.ccache
  # --- 预定义变量以消除编辑器的黄色警告 ---
  DEVICE_NAME: ""
  FILE_DATE: ""
  FIRMWARE: ""

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo -E apt-get -qq update
          # --- 这里的 uuid-dev 是必须的，否则 firmware-utils 会报错 ---
          sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
            genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
            python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
            swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev uuid-dev
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          mkdir -p "${{ github.workspace }}/build"

      - name: Clone Source Code
        working-directory: ${{ github.workspace }}/build
        run: |
          git clone -b $REPO_BRANCH $REPO_URL openwrt
          ln -sf "${{ github.workspace }}/build/openwrt" "$GITHUB_WORKSPACE/openwrt"

      - name: Compute feeds.conf.default hash
        id: feeds_hash
        run: |
          # compute a runtime hash of feeds.conf.default (handle possible locations)
          if [ -f "${{ github.workspace }}/openwrt/feeds.conf.default" ]; then
            FEED_HASH=$(sha256sum "${{ github.workspace }}/openwrt/feeds.conf.default" | cut -d' ' -f1)
          elif [ -f "${{ github.workspace }}/build/openwrt/feeds.conf.default" ]; then
            FEED_HASH=$(sha256sum "${{ github.workspace }}/build/openwrt/feeds.conf.default" | cut -d' ' -f1)
          else
            FEED_HASH="no-feeds-conf"
          fi
          echo "feed_hash=${FEED_HASH}" >> $GITHUB_OUTPUT
          echo "Computed feed hash: ${FEED_HASH}"

      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            /home/runner/.ccache
          key: ${{ runner.os }}-openwrt-${{ steps.feeds_hash.outputs.feed_hash }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: Enable / Pull missing official feeds (add if absent)
        working-directory: ${{ github.workspace }}/build/openwrt
        run: |
          set -eux
          FEEDS_CONF="feeds.conf.default"

          # Ensure file exists
          [ -f "$FEEDS_CONF" ] || touch "$FEEDS_CONF"

          add_feed() {
            name="$1"
            url="$2"
            if grep -qE "^[[:space:]]*src-(git|svn)[[:space:]]+$name[[:space:]]" "$FEEDS_CONF"; then
              echo "Feed '$name' already present in $FEEDS_CONF"
            else
              echo "Adding feed: $name -> $url"
              echo "src-git $name $url" >> "$FEEDS_CONF"
            fi
          }

          # Official OpenWrt feeds - these supply common packages (bc, pciutils, wsdd2, libpam, ddns-scripts, wget-ssl, etc.)
          add_feed packages https://github.com/openwrt/packages
          add_feed luci https://github.com/openwrt/luci
          add_feed routing https://github.com/openwrt/routing
          add_feed telephony https://github.com/openwrt/telephony

          echo "Updated $FEEDS_CONF:"
          sed -n '1,200p' "$FEEDS_CONF" || true

      - name: Load Custom Feeds (DIY Part 1)
        run: |
          [ -e "$GITHUB_WORKSPACE/diy-part1.sh" ] && chmod +x "$GITHUB_WORKSPACE/diy-part1.sh" && cd openwrt && "$GITHUB_WORKSPACE/diy-part1.sh" || echo "diy-part1.sh not found"

      - name: Update Feeds (refresh after enabling feeds)
        working-directory: ${{ github.workspace }}/build/openwrt
        run: |
          set -eux
          ./scripts/feeds update -a || true
          ./scripts/feeds install -a || true

      - name: Install Feeds (custom handling)
        working-directory: ${{ github.workspace }}/build/openwrt
        run: |
          set -eux
          cd "${{ github.workspace }}/build/openwrt"

          # --- [关键修复 1] 替换 Golang 为 sbwml 版本 (必须保留，否则 Passwall 会报错) ---
          echo "Replacing Golang with sbwml version..."
          rm -rf feeds/packages/lang/golang
          git clone https://github.com/sbwml/packages_lang_golang -b 23.x feeds/packages/lang/golang

          # --- [关键修复 2] 删除 v2ray-plugin (已知有问题)
          echo "Removing broken v2ray-plugin (if present)..."
          rm -rf feeds/passwall_packages/v2ray-plugin || true

          # Re-update feeds and install by category (keeps previous behavior)
          ./scripts/feeds update -a || true

          ./scripts/feeds install -p passwall_packages -f -a || true
          ./scripts/feeds install -p packages -f -a || true
          ./scripts/feeds install -p luci -f -a || true
          ./scripts/feeds install -p routing -f -a || true
          ./scripts/feeds install -f -a || true

      - name: Load Custom Configuration (DIY Part 2)
        run: |
          [ -e "$GITHUB_WORKSPACE/diy-part2.sh" ] && chmod +x "$GITHUB_WORKSPACE/diy-part2.sh" && cd openwrt && "$GITHUB_WORKSPACE/diy-part2.sh" || echo "diy-part2.sh not found"

      - name: Generate Configuration
        working-directory: ${{ github.workspace }}/build/openwrt
        run: |
          set -eux
          cd "${{ github.workspace }}/build/openwrt"

          # --- 目标设备配置 (示例，按需修改) ---
          # echo "CONFIG_TARGET_ramips=y" >> .config
          # echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
          # echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> .config

          # 编译优化
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_SDK=n" >> .config
          echo "CONFIG_IB=n" >> .config
          echo "CONFIG_KO_SYMBOLS=n" >> .config
          echo "CONFIG_BUILD_LOG=n" >> .config

          # 插件配置（heredoc lines must not be indented)
          cat >> .config <<'EOF'
          CONFIG_PACKAGE_ipv6helper=y
          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_SingBox=y
          CONFIG_PACKAGE_luci-app-ddns=y
          CONFIG_PACKAGE_ddns-scripts=y
          # CONFIG_PACKAGE_ddns-scripts_aliyun=y
          # CONFIG_PACKAGE_ddns-scripts_dnspod=y
          CONFIG_PACKAGE_luci-app-vlmcsd=y
          CONFIG_PACKAGE_luci-app-smartdns=y
          CONFIG_PACKAGE_luci-app-ipsec-vpnd=y
          CONFIG_PACKAGE_luci-app-usb-printer=y
          CONFIG_PACKAGE_luci-app-autoreboot=y
          CONFIG_PACKAGE_luci-app-filetransfer=y
          CONFIG_PACKAGE_luci-theme-argon=y
          CONFIG_PACKAGE_luci-app-argon-config=y
          EOF

          # 清理并生成最终配置：删除可能导致问题或不想自动构建的条目
          sed -i '/CONFIG_PACKAGE_geoview/d' .config
          sed -i '/CONFIG_PACKAGE_luci-app-geoview/d' .config

          make defconfig

      - name: Download package
        id: package
        working-directory: ${{ github.workspace }}/build/openwrt
        run: |
          set -eux
          cd "${{ github.workspace }}/build/openwrt"
          echo "Downloading packages..."
          # allow download step to continue even if some packages fail to download
          make download -j8 || true
          # remove small/incomplete archives
          find dl -type f -size -1024c -exec ls -l {} \; -exec rm -f {} \;

      - name: Clean known-bad dl files (force re-download of problematic archives)
        working-directory: ${{ github.workspace }}/build/openwrt
        run: |
          set -eux
          cd "${{ github.workspace }}/build/openwrt"
          # Remove specific cached archives that are known to produce hash mismatches (if present)
          rm -f dl/wsdd2-*.tar.* || true
          find dl -type f -name "*-corrupt*" -delete || true

      - name: Set up Go 1.24 (required for some feed packages)
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Compile the firmware
        id: compile
        working-directory: ${{ github.workspace }}/build/openwrt
        run: |
          set -eux
          cd "${{ github.workspace }}/build/openwrt"
          echo "Starting build process..."

          echo "1. Compiling host tools..."
          if ! make tools/compile -j$(nproc); then
            echo "tools_compile_failed=1" >> $GITHUB_OUTPUT
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "2. Compiling toolchain..."
          if ! make toolchain/compile -j$(nproc); then
            echo "toolchain_compile_failed=1" >> $GITHUB_OUTPUT
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "3. Compiling firmware..."
          # 优先多线程编译，失败时降级到单线程并输出详细日志
          if make -j$(nproc); then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "Multi-thread build failed, retrying single-threaded..."
            if make -j1 V=s; then
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # --- 优化：提取设备名 ---
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME || true
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV || echo "DEVICE_NAME=_Generic" >> $GITHUB_ENV

          echo "FILE_DATE=_$(date +\"%Y%m%d%H%M\")" >> $GITHUB_ENV

      - name: Save Cache
        if: steps.compile.outputs.status == 'success'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            /home/runner/.ccache
          key: ${{ runner.os }}-openwrt-${{ steps.feeds_hash.outputs.feed_hash }}

      - name: Check space usage
        if: (!cancelled())
        run: df -hT

      - name: Upload bin directory
        uses: actions/upload-artifact@v6
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin

      - name: Organize files
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          if [ -d "openwrt/bin/targets" ]; then
            cd openwrt/bin/targets/*/*
            rm -rf packages
            echo "FIRMWARE=$PWD" >> $GITHUB_ENV
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "Target directory not found. Build might have failed."
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Upload firmware directory
        uses: actions/upload-artifact@v6
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: Generate release tag
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
        run: |
          echo "release_tag=v$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          touch release.txt
          echo "Auto Build by GitHub Actions" >> release.txt
          echo "Lede OpenWrt Latest Build" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload firmware to release
        uses: softprops/action-gh-release@master
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 2

      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@master
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
